---
import { getCollection } from 'astro:content';
import BaseLayout from '../../../layouts/BaseLayout.astro';
import '../../../styles/global.css';

export const prerender = true;

export async function getStaticPaths() {
  const allPosts = await getCollection('blog');
  const allTags = new Set();

  allPosts.forEach(post => {
    if (post.data.tags) {
      post.data.tags.forEach(tag => allTags.add(tag));
    }
  });

  return Array.from(allTags).map(tag => ({
    params: { tag },
    props: {
      tag,
      posts: allPosts.filter(post => post.data.tags?.includes(tag))
    }
  }));
}

const { tag, posts } = Astro.props;
const sortedPosts = posts.sort((a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime());
---

<BaseLayout pageTitle={`Posts tagged "${tag}" - Tom Hanover`} description={`Blog posts tagged with ${tag}`}>
	<div class="p-6">
		<div class="max-w-4xl mx-auto">
			<header class="mb-12">
				<a href="/blog" class="text-ctp-teal hover:text-ctp-teal/80 inline-flex items-center mb-6">
					<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
					</svg>
					Back to All Posts
				</a>
				<h1 class="text-5xl font-bold mb-4">
					Posts tagged <span class="text-ctp-teal lowercase">{`"${tag}"`}</span>
				</h1>
				<p class="text-xl text-ctp-subtext1">{`${sortedPosts.length} ${sortedPosts.length === 1 ? 'post' : 'posts'}`}</p>
			</header>

			<div class="space-y-6">
				{sortedPosts.map((post) => (
					<article class="bg-ctp-surface0/50 backdrop-blur-sm rounded-lg p-6 shadow-lg hover:bg-ctp-teal/60 transition-colors">
						<a href={`/blog/${post.slug}`} class="group">
							<h2 class="text-2xl font-bold mb-2 text-ctp-teal group-hover:text-ctp-teal/80 transition-colors">
								{post.data.title}
							</h2>
							<p class="text-ctp-subtext1 mb-3">{post.data.description}</p>
							<div class="flex items-center gap-4 text-sm text-ctp-subtext0">
								<time datetime={post.data.pubDate.toISOString()}>
									{post.data.pubDate.toLocaleDateString('en-US', {
										year: 'numeric',
										month: 'long',
										day: 'numeric'
									})}
								</time>
								{post.data.tags && (
									<div class="flex gap-2">
										{post.data.tags.map((postTag) => (
											<a
												href={`/blog/tag/${postTag}`}
												class="bg-ctp-teal text-ctp-crust px-2 py-1 rounded text-xs lowercase hover:bg-ctp-teal/80 transition-colors"
											>
												{postTag}
											</a>
										))}
									</div>
								)}
							</div>
						</a>
					</article>
				))}
			</div>
		</div>
	</div>
</BaseLayout>

